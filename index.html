<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>GitHub Search (React/JSX)</title>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/milligram/1.3.0/milligram.css" />
    <style>
      .title { padding-top: 2rem; }
      .search { padding-top: 2rem; }
    </style>
    <script src="https://unpkg.com/@babel/standalone@7.13.12/babel.min.js"></script>
  </head>
  <body>
    <div id="root" class="container"></div>
    <script type="text/jsx" data-type="module">
      import React, {useState} from 'https://cdn.skypack.dev/react@17';
      import ReactDOM from 'https://cdn.skypack.dev/react-dom@17';

      const SearchForm = ({setRepositories, repositories }) => {
        const [searchStr, setSearchStr] = useState('');
        const [query, setQuery] = useState('');
        const [total, setTotal] = useState(0);
        const [page, setPage] = useState(1);
        const per_page = 30; // 30
        let disableLoadMore = (page-1) * per_page >= total;

        /*
         * searchGithub cb for search button
         */
        const searchGithub = (e, setRepositories, repositories) => {
          e.preventDefault();
          if (searchStr !== query) {
            // clear results with new search
            setQuery(searchStr);
            setRepositories([]);
            repositories = [];
          }
          fetch(`https://api.github.com/search/repositories?q=${
            searchStr
          }&sort=stars&page=${
            page
          }&order=desc&per_page=${per_page}`)
          .then(response => response.json())
          .then(data => {
            console.log('gh res', data);
            setRepositories(repositories.concat(data.items));
            setPage(page+1);
            setTotal(data.total_count);
          });
        }; 
        
        const LoadMoreButton = ({ setRepositories, repositories, disabled }) => {
          return (
            <button
              id="loadMoreButton"
              disabled={disabled}
              onClick={(e) => searchGithub(e, setRepositories, repositories)}
            >
              Load more
            </button>
          );
        }

        return (
          <form>
            <input id="searchQuery" type="text" placeholder="Name, language..."
              value={searchStr}
              onChange={(e) => setSearchStr(e.target.value)}
            />
            <button
              class="button-primary"
              onClick={(e) => searchGithub(e, setRepositories, repositories)}
              type="submit"
              disabled={searchStr === query || searchStr === ''}
            >
              Search
            </button>
            <LoadMoreButton
              disabled={searchStr === '' || disableLoadMore}
              setRepositories={setRepositories}
              repositories={repositories}
            />
          </form>
        );
      }

      const row = ({count, name, language, stars}) => {
        return (<tr>
          <td>{count}</td>
        <td>
          <a
            href="https://github.com/facebook/react"
            target="_blank"
          >
            {name}
          </a>
        </td>
        <td>{language}</td>
        <td>{stars}</td>
      </tr>);
      }

      const SearchResults = ({results}) => {
        if (!results) {
          return
        }
        let rows = results.map((r, i) => row({
          count: i+1,
          name:r.full_name,
          language:r.language,
          stars: r.stargazers_count >= 1000
          ? `${r.stargazers_count%1000}k` : r.stargazers_count
          })
        );
        return (
          <table id="searchResults">
            <thead>
              <tr>
                <th>Count</th>
                <th>Name</th>
                <th>Language</th>
                <th>Stars</th>
              </tr>
            </thead>
            <tbody>
              {rows}
            </tbody>
          </table>
        );
      }

      const App = () => {
        const [repositories, setRepositories] = useState([]);

        return (
          <>
            <h1 class="title">GitHub Search</h1>
            <SearchForm
              setRepositories={setRepositories}
              repositories={repositories}
            />
            <SearchResults results={repositories} />
          </>
        );
      };
      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
  </body>
</html>